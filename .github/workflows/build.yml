name: Build Tauri from Private Repository

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  # Tauri Windows 构建
  build-tauri-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout private repository
      uses: actions/checkout@v4
      with:
        repository: tianjg-com/SR-Tools
        token: ${{ secrets.SR_TOKEN }}
    
    - name: Extract version from version.ts
      id: get-version
      run: |
        # 从 version.ts 文件中提取版本号
        if (Test-Path "app/config/version.ts") {
          $versionContent = Get-Content "app/config/version.ts" -Raw
          if ($versionContent -match "export const APP_VERSION = '([^']+)'") {
            $version = $matches[1]
            echo "🎯 检测到版本号: $version"
            echo "version=$version" >> $env:GITHUB_OUTPUT
          } else {
            echo "⚠️ 未能从 version.ts 中提取版本号，使用默认版本"
            echo "version=unknown" >> $env:GITHUB_OUTPUT
          }
        } else {
          echo "❌ version.ts 文件不存在"
          echo "version=unknown" >> $env:GITHUB_OUTPUT
        }
    
    - name: Display build info
      run: |
        echo "🚀 开始构建 SR-Tools"
        echo "📦 版本号: ${{ steps.get-version.outputs.version }}"
        echo "📅 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        echo "🖥️ 平台: Windows"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build Tauri app
      run: |
        npm run generate
        npm run tauri build -- --no-bundle
    
    - name: Rename executable
      run: |
        Copy-Item "src-tauri/target/release/tianjg_com.exe" "src-tauri/target/release/SR-Tools-v${{ steps.get-version.outputs.version }}.exe"
    
    - name: Delete old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          // 删除名称以 SR-Tools- 开头的旧构建产物
          const oldArtifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          for (const artifact of oldArtifacts.data.artifacts) {
            if (artifact.name.startsWith('SR-Tools-') && artifact.name !== 'SR-Tools-${{ steps.get-version.outputs.version }}') {
              console.log(`Deleting old artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }
          }
    
    - name: Upload Tauri executable
      uses: actions/upload-artifact@v4
      with:
        name: SR-Tools-${{ steps.get-version.outputs.version }}
        path: src-tauri/target/release/SR-Tools-v${{ steps.get-version.outputs.version }}.exe
        retention-days: 30
        overwrite: true

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.get-version.outputs.version }}
        name: SR-Tools v${{ steps.get-version.outputs.version }}
        body: |
          🎮 Star Rail Tools v${{ steps.get-version.outputs.version }}
          
          ## 下载
          - Windows: [SR-Tools-v${{ steps.get-version.outputs.version }}.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get-version.outputs.version }}/SR-Tools-v${{ steps.get-version.outputs.version }}.exe)
          
          ## 更新内容
          - 自动构建版本 v${{ steps.get-version.outputs.version }}
          - 构建时间: ${{ github.run_id }}
        files: |
          src-tauri/target/release/SR-Tools-v${{ steps.get-version.outputs.version }}.exe
        draft: false
        prerelease: false

    # 清理旧的工作流运行记录
    - name: 清理工作流运行历史
      if: success() || failure()
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 1  # 只保留最近1次运行记录
